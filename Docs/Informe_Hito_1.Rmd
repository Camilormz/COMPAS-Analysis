---
title: "Análisis de COMPAS como predictor sesgado"
output: html_notebook
---

**Ignacia Aguilera, Camilo Ramírez, Sebastián Zapata** - ***Grupo 16***<br>
Curso CC5206 Introducción a la Minería de Datos<br>
Profesores: Felipe Bravo, Bárbara Poblete<br>
Facultad de Ciencias Físicas y Matemáticas, Universidad de Chile

# Introducción y motivación

Este informe se enmarca en el curso de Introducción a la Minería de Datos (CC5206) de la Universidad de Chile, para documentar el hito inicial (1) del proyecto minería de datos sobre el dataset asociado a COMPAS de [Northpointe](https://www.northpointe.com/) generado por [ProPublica](https://www.propublica.org/).

COMPAS es el acrónimo de *Correctional Offender Management Profiling for Alternative Sanctions*, que es traducible como "Gestión de perfiles de reos penitenciarios para penas alternativas" y corresponde a un algoritmo que busca predecir la probabilidad de reincidencia de un criminal al asignarle un puntaje (*score*) que representa la misma ([se puede encontrar su documentación aquí](https://assets.documentcloud.org/documents/2840784/Practitioner-s-Guide-to-COMPAS-Core.pdf)). Este método pertenece a la familia de algoritmos de evaluación de riesgo penitenciario (*risk assesment*) y se ha utilizado en diversas cortes de Estados Unidos como insumo para los jueces en la determinación del otorgamiento de libertad condicional a los imputados por algún delito.Esto responde a la necesidad de ese país de doscongestionar sus prisiones de forma eficiente. Es importante distinguir que este algoritmo no fue diseñado ni se ha utilizado para determinar la culpabilidad de alguna persona en un delito, ni para determinar una pena.

Un [estudio](https://www.propublica.org/article/machine-bias-risk-assessments-in-criminal-sentencing) realizado por ProPublica encontró un significativo sesgo racial en los resultados de puntaje COMPAS a desfavor de las personas afroamericanas a pesar que este atributo de las personas no se ingresaba como entrada al algoritmo. ProPublica además de publicar los resultados del estudio, publicó su [metdología](https://github.com/caitlinkuhlman/bpdmtutorial/blob/master/tutorial-COMPAS.ipynb) y un dataset generado a partir de la reccopilación de datos realizada por la agencia periodística. Las publicaciones se encuentran presente en el [repositorio de GitHub](https://github.com/propublica/compas-analysis) de ProPublica

# Problemática central

La problematica a abordar en este proyecto se basa en el análisis de datos del dataset "compas", principalmente al estudio efectuado por ProPublica que revela una serie de sesgos que son identificables en la metodologia de estimación para predecir la probabilidad de reincidencia de un criminal debido a estos datos es necesario un análisis para poder identificar datos relevantes.

El objetivo de este proyecto es analizar y detectar los posibles sesgos que tenga COMPAS en un espectro más amplio de atributos además de verificar el sesgo racial descrito por el informe de ProPublica. Adicional a esto se busca determinar una forma de disminuir los sesgos detectados o determinar la imposibilidad de realizar lo anterior mediante la exploración de los datos correspondientes en el hito 1.

Para esto se pretende abordar en tornos a los datos, las correlaciones entres los distintos atributos como indice de reinicidencia, raza, sexo, rango de edad, etc. Esto permitira encontrar sesgos que podran ser los mismo presentados por ProPublica y/o otros. Para cumplir este objetivo se trabaja con el dataset principal publicado en el repositorio contenido en el fichero ```compas.db``` que corresponde a una base de datos de sqlite3. Esta se importa en R y utilizando esta herramienta, se hace un análisis de datos, eventualmente una limpieza y reducción de atributos para comenzar a analizar correlaciones que se puedan encontrar, los atributos que se consideran de interés corresponden a la etnia (raza) y género de las personas. En base a correlaciones de interés encontradas, se aplicarán herramientas de minería de datos más sofisticadas en los próximos hitos del proyecto.

Otras formas de encontrar relaciones y explorar los datos para el hito 1, sera relacionar las salidas del sistema con las variables de entrada, tambien podemos definir relaiones de interdependencia entre las variables que componen el dataset.

# Descripción de los datos 

En primer lugar, para trabajar de manera cómoda con la base de datos, es necesario contar con un diagrama Entidad-Relación de esta. Así es posible realizar una inspección visual de las tablas de manera compacta y hacerse una idea del entorno sobre el cuál se trabaja. Para crear este diagrama, se hizo uso de un software llamado [DB Browser for SQLite](https://sqlitebrowser.org/) que permite convertir ficheros de extensión *.db* a ficheros con instrucciones SQL para recrear esta base de datos en cualquier sistema que permita dicho lenguaje. Dentro de este programa, se abrió el archivo ```compas.db``` para luego exportarlo en formato SQL.

Obtenido un archivo ```compas.sql```, se hace uso de un segundo software: [MySQL Workbench](https://www.mysql.com/products/workbench/). Este permite leer archivos de extensión *.sql* para generar una nueva base de datos. Para continuar el proceso, dentro del programa se debe crear un nuevo modelo para posteriormente importar el nuevo archivo generado anteriormente. Al hacerlo, se genera automáticamente un diagrama de Entidad-Relación, este se muestra a continuación:

![Diagrama de Entidad-Relación generado por MySQL Wekbench](compas_ER_model.png)

Es necesario mencionar que las instrucciones SQL del archivo generado con la herramienta *DB Browser* no cuentan con un máximo de caracteres para las columnas de tipo *VARCHAR* por lo que se debe editar manualmente para añadir un máximo de caracteres como sigue: *VARCHAR(255)*. A partir de este diagrama, es posible identificar que la tabla **people** (relativa a las personas) es la columna vertebral de esta base de datos. Alrededor de esta tabla, se pueden encontrar seis más ("compas", "jailhistory", "casearrest, "summary", "prisonhistory" y "charge") con distintos atributos que pertenecen a una persona en específico (notar la llave foránea al id de una persona), estos datos serán analizados posteriormente.

# Exploración de datos

A modo de hacer el informe replicable, se deja explícito el código fuente utilizado. Para trabajar con ```compas.db``` se comienza importando las librerías requeridas, importando el fichero de la base de datos a través de una clase de SQL manejable por R para posteriormente extraer los dataframes del mismo.
```{r, results="hide"}
library(RSQLite)

filename <- "compas.db"
sqlite.driver <- dbDriver("SQLite")
db <- dbConnect(sqlite.driver, dbname = filename)

casearrest    <- dbReadTable(db,"casearrest")
charge        <- dbReadTable(db,"charge")
compas        <- dbReadTable(db,"compas")
jailhistory   <- dbReadTable(db,"jailhistory")
prisonhistory <- dbReadTable(db,"prisonhistory")
summary       <- dbReadTable(db,"summary")
people        <- dbReadTable(db,"people")
```

A continuación se exhiben algunos valores que muestran la correlación de diversos datos que pueden resultar de interés. Un valor de correlación se expresa como la forma de medir la dependencia entre dos variables (X,Y) y como es que una de ellas se comportaría al hacer variar la otra. De esta forma, mientras este valor esté muy cercano a 1, se dice que los datos están fuertemente correlacionados, su proporción es casi directa. Por otro lado, si se acerca mucho a -1 , quiere decir que los datos son demasiado correlacionados inversamente. Para valores cercanos a 0, se dice que la relación entre los datos es casi nula. Y no existe relación alguna si este valor es igual a 0.

```{r}
compas_violence = merge(compas[compas$scale_id == 7, ], people, by.x = "person_id", by.y = "id")
compas_recidivism = merge(compas[compas$scale_id == 8, ], people, by.x = "person_id", by.y = "id")
compas_failure_appear = merge(compas[compas$scale_id == 18, ], people, by.x = "person_id", by.y = "id")

cor(people$age, people$decile_score)
```

Se separaron los puntajes de compas entre los tres distintos podibles: *Risk of Violence*, *Risk of Recidivism* y *Risk of Failure to Appear*. Luego se hizo uso de la función *cor* de R donde se analizó la correlación entre distintas variables, tales como: edad, sexo, raza o si ha sido reincidente con o sin violencia.

Escribimos la ubicación del archivo compas.db
Utilizamos los drivers instalados de SQLite para poder pasar el archivo a un data.frame que puede ser manipulado por R.
```{r}
filename <- "compas.db"
sqlite.driver <- dbDriver("SQLite")
db <- dbConnect(sqlite.driver,
                dbname = filename)
```

El objeto db contiene las 7 tablas que pertenecen a compas.
Para obtener un dataframe con alguna de las tablas, vasta con descomentar la linea que lee una tabla.

```{r}
dbListTables(db)
# tabla_compas <- dbReadTable(db,"people")
```


Le damos nombres a los distintos dataframe
1. People
```{r}
people <- dbReadTable(db,"people")
head(people)
```
Vemos el tamaño del dataframe 
```{r}
# Para indicar el número de filas y columnas de d
dim(people)
```
Atributos de dataframe
```{r}
str(people)
```
Estadisticas 
```{r}
summary(people)
```
# Consultas sobre data frames (proyección y filtro)
Analizando algunos parametro del dataframe "people"
```{r}
people[order(people$age),]
```
# Graficando 
Fitrar de acuerdo a las hombre con edad de 18 años, ver su raza y su puntaje 
```{r}
head(people[people$sex=="Female", c("race","decile_score")])
```
Fitrar de acuerdo a las mujeres, ver su raza y su puntaje 
De acuerdo al grafico vemos una clara tendencia de raza afroamericana con mayor puntaje 
```{r}
peopleFemale <- people[people$sex == "Female", ]
head(peopleFemale)
library(ggplot2)
ggplot(peopleFemale) +   # asociamos un data frame a ggplot
  geom_bar(aes(x = race, y = decile_score), stat="identity") +   # creamos un grafico de barras como una capa
  coord_flip() +  # transformamos el grafico invirtiendo los ejes de coordenadas (sólo visualmente)
  ggtitle("Distribución de mujeres de acuerdo a su raza y su puntaje") + # título
  xlab("Race") + ylab("Score")  
```
Se puede encontrar una correlación entre la raza y su puntaje, lo que nos muestra el grafico es que la raza African-American y Caucasian son maypritarias en las mujeres.
```{r}
peopleFemale <- people[people$sex == "Female", ]
head(peopleFemale)
library(ggplot2)
ggplot(peopleFemale) +   # asociamos un data frame a ggplot
  geom_bar(aes(x = race, y = is_violent_recid), stat="identity") +   # creamos un grafico de barras como una capa
  coord_flip() +  # transformamos el grafico invirtiendo los ejes de coordenadas (sólo visualmente)
  ggtitle("Distribución de mujeres de acuerdo a su raza y su indice violencia ") + # título
  xlab("Race") + ylab("Violent")  
```
```{r}
peopleAfromaerican <- people[people$race == "African-American", ]
head(peopleAfromaerican)
library(ggplot2)
ggplot(peopleAfromaerican) +   # asociamos un data frame a ggplot
  geom_bar(aes(x = age, y = decile_score), stat="identity") +   # creamos un grafico de barras como una capa
  coord_flip() +  # transformamos el grafico invirtiendo los ejes de coordenadas (sólo visualmente)
  ggtitle("Distribución de afroamericanos de acuerdo a su edad y puntaje") + # título
  xlab("Age") + ylab("Score")  
```
Hay una correlación entre la edad y el puntaje para la raza African-American, donde podemos notar que a menor edad mayor puntaje, pero en una concentración.

```{r}
peopleAge <- people[people$age < "30", ]
head(peopleAge)
library(ggplot2)
ggplot(peopleAge) +   # asociamos un data frame a ggplot
  geom_bar(aes(x = sex, y = decile_score), stat="identity") +   # creamos un grafico de barras como una capa
  coord_flip() +  # transformamos el grafico invirtiendo los ejes de coordenadas (sólo visualmente)
  ggtitle("Distribución de personas menores de 30 años y puntaje") + # título
  xlab("Sex") + ylab("Score")  
```
Este grafico nos muestra una correlacion entre las personas menores de 30 que su puntaje es mayor para el sexo masculino.
Grafico densidad de edad
Podemos ver que se concentran las edades mas jovenes
Distribución de edad en la gente que ha sido encuestada
```{r}
plot(density(people$age))
```
Este grafico nos muestra la densidad de la edad de las personas y nos muestra una relacion de la concentracion de edad

Grafico de densidad del puntaje del compas 
```{r}
plot(density(people$decile_score))
```
Este grafico nos muestra la densidad de puntaje de las personas y nos muestra la concentracion del puntaje siendo mayoritario entre 0 y 2
Por ggplot

2. Casearrest
```{r}
casearrest <- dbReadTable(db,"casearrest")
head(casearrest)
```
Vemos el tamaño del dataframe
```{r}
# Para indicar el número de filas y columnas de d
dim(casearrest)
```

3. charge
```{r}
charge <- dbReadTable(db,"charge")
head(charge)
```

4. compas
```{r}
compas <- dbReadTable(db,"compas")
head(compas)
```
```{r}
peopleAge <- compas
library(ggplot2)
ggplot(compas) +   # asociamos un data frame a ggplot
  geom_bar(aes(x = marital_status, y = decile_score), stat="identity") +   # creamos un grafico de barras como una capa
  coord_flip() +  # transformamos el grafico invirtiendo los ejes de coordenadas (sólo visualmente)
  ggtitle("Distribución de estado civil y puntaje") + # título
  xlab("Estado civil") + ylab("Score")  
```
```{r}
peopleAge <- compas
library(ggplot2)
ggplot(compas) +   # asociamos un data frame a ggplot
  geom_bar(aes(x = type_of_assessment, y = decile_score), stat="identity") +   # creamos un grafico de barras como una capa
  coord_flip() +  # transformamos el grafico invirtiendo los ejes de coordenadas (sólo visualmente)
  ggtitle("Distribución de tipificacion de evaluación y puntaje") + # título
  xlab("Tipificación de la evaluación") + ylab("Score")  
```
```{r}
peopleAge <- compas
library(ggplot2)
ggplot(compas) +   # asociamos un data frame a ggplot
  geom_bar(aes(x = score_text, y = decile_score), stat="identity") +   # creamos un grafico de barras como una capa
  coord_flip() +  # transformamos el grafico invirtiendo los ejes de coordenadas (sólo visualmente)
  ggtitle("Relación de la tipificacion del puntaje y el puntaje") + # título
  xlab("Tipificación score") + ylab("Score")  
```
5. jailhistory
```{r}
jailhistory <- dbReadTable(db,"jailhistory")
head(jailhistory)
```
6. prisonhistory
```{r}
prisonhistory <- dbReadTable(db,"prisonhistory")
head(prisonhistory)
```
7. summary
```{r}
summary <- dbReadTable(db,"summary")
head(summary)
```


Realizamos exploración de datos 
Numero de filas
```{r}
# Para indicar el número de filas de d.
nrow(db)
```